{{- define "cwa-tests.run.feature-test-runner" -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-ft-runner-job
  labels:
    app.kubernetes.io/managed-by: Helm
    meta.helm.sh/release-name: {{ .Release.Name }}
    meta.helm.sh/release-namespace: {{ .Values.global.namespace }}
spec:
  ttlSecondsAfterFinished: 100
  completions: 50  # Number of pods to run in parallel
  parallelism: 50  # Number of pods to run at the same time
  template:
    metadata:
      labels:
        app: ft-runner-job
    spec:
      containers:
      - name: ft-runner-job
        image: "{{ .Values.global.registryAddress }}/{{ .Values.global.regPath }}:{{ .Values.ecr.image.tag }}"
        securityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: "{{ .Values.securityContext.seccompProfile.type }}"
        env:
        - name: REDIS_SERVICE
          value: "redis://{{ .Release.Name }}-redis-service.{{ .Values.global.namespace }}.svc.cluster.local:6379"
        - name: WORK_Q
          value: "{{ .Values.ftRunnerJob.work_q }}"
        - name: TEST_ENV
          value: "{{ .Values.global.test_env }}"
        - name: HEADLESS 
          value: "{{ .Values.ftRunnerJob.headless }}"
        - name: USE_API 
          value: "{{ .Values.ftRunnerJob.use_api }}"
        - name: CWA_PROVIDER_LOGGING
          value: "{{ .Values.ftRunnerJob.cwa_provider_logging }}"
        - name: API_URL
          value: "{{ .Values.ftRunnerJob.api_url }}"
        resources:
          requests:
            cpu: 1500m
            memory: 8192Mi
          limits:
            cpu: 4000m
            memory: 8192Mi
        command: ["ruby", "runner.rb"]
        volumeMounts:
          - name: screenshots
            mountPath: /screenshots
      volumes:
        - name: screenshots
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-screenshots-pvc
      restartPolicy: Never
      serviceAccountName: {{ .Values.global.serviceAccount }}
---
{{- end -}}