version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.0.0
  aws-ecr: circleci/aws-ecr@8.2.1

# ------------------
# EXECUTORS
# ------------------
executors:
  build-executor:
    docker:
      - image: cimg/base:2023.03
    working_directory: ~/

jobs:
  Build and Push Docker Image:
    executor: build-executor
    steps:
      - checkout
      - run:
          name: Decrypt secrets
          command: |
            echo "${GIT_CRYPT_KEY}" | base64 -d > git-crypt.key
            git-crypt unlock git-crypt.key
      - aws-cli/setup:
          role_arn: $ECR_ROLE_TO_ASSUME
          region: $ECR_REGION
      - run: |
          aws ecr get-login-password --region $ECR_REGION | docker login --username AWS --password-stdin ${AWS_ECR_REGISTRY_ID}.dkr.ecr.${ECR_REGION}.amazonaws.com
      - run:
          name: Build docker image
          command: |
            export SANITISED_BRANCH=$(echo "${CIRCLE_BRANCH,,}" | sed -r 's/[/_]+/-/g')
            docker build . -f ./DockerServiceDescription/TestImageDockerfile -t foo
            docker tag foo ${AWS_ECR_REGISTRY_ID}/${ECR_REPOSITORY}:${CIRCLE_SHA1}
            docker tag foo ${AWS_ECR_REGISTRY_ID}/${ECR_REPOSITORY}:${SANITISED_BRANCH}
            docker image ls
      - run:
          name: Push to ECR
          command: |
            docker push --all-tags ${AWS_ECR_REGISTRY_ID}/${ECR_REPOSITORY}

workflows:
  version: 2
  build_and_push:
    jobs:
      - Build and Push Docker Image
