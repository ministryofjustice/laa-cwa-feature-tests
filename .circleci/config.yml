version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.0.0
  aws-ecr: circleci/aws-ecr@8.2.1
  helm: circleci/helm@2.0.1
  slack: circleci/slack@4.12.5
  python: circleci/python@3.0.0

parameters:
  environment:
    type: enum
    enum: [dev, tst, uat, stg]
    default: dev
    description: "Select the environment to deploy to"

# ------------------
# EXECUTORS
# ------------------
executors:
  build-executor:
    docker:
      - image: cimg/base:2023.03
  deploy-executor:
    resource_class: small
    docker:
      - image: ministryofjustice/cloud-platform-tools

jobs:
  generate_release_name:
    docker:
      - image: cimg/ruby:3.2
    steps:
      - checkout
      - run:
          name: Install Gem
          command: gem install petname
      - run:
          name: Run Ruby Script
          command: |
            ruby docker/scripts/generate_release_name.rb > release_name.txt
      - store_artifacts:
          path: release_name.txt
          destination: release_name.txt
      - persist_to_workspace:
          root: .
          paths:
            - release_name.txt

  push_to_redis:
    docker:
      - image: cimg/ruby:3.3.4
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Authenticate with cluster
          command: |
            echo -n ${KUBE_CERT} | base64 -d > ./ca.crt
            kubectl config set-cluster ${KUBE_CLUSTER} --certificate-authority=./ca.crt --server=https://${KUBE_CLUSTER}
            kubectl config set-credentials circleci --token=${KUBE_TOKEN}
            kubectl config set-context ${KUBE_CLUSTER} --cluster=${KUBE_CLUSTER} --user=circleci --namespace=${KUBE_NAMESPACE}
            kubectl config use-context ${KUBE_CLUSTER}
            kubectl get pods
      - run:
          name: Install dependencies
          command: |
            gem install redis
            sudo apt-get update && sudo apt-get install -y netcat
      - run:
          name: Wait for Redis to be ready
          command: |
            RELEASE_NAME=$(cat release_name.txt)
            REDIS_SERVICE="${RELEASE_NAME}-redis-service"
            until nc -z "${REDIS_SERVICE}" 6379; do
              echo "Waiting for Redis..."
              sleep 2
            done
            echo "Redis is up and running!"

      - run:
          name: Check for features.txt and push to Redis
          command: ruby push_to_redis.rb

  deploy_test_setup:
    executor: deploy-executor
    parameters:
      environment:
        description: Destination environment
        type: string
        default: laa-cwa-feature-tests-dev
      token:
        description: CircleCI Service account token
        type: string
        default: ${CIRCLE_CI_TOKEN} 
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Load environment variables
          command: |
            if [ -f bash.env ]; then
              cat bash.env >> $BASH_ENV
              source $BASH_ENV
            fi
      - run:
          name: Authenticate with cluster
          command: |
            echo -n ${KUBE_CERT} | base64 -d > ./ca.crt
            kubectl config set-cluster ${KUBE_CLUSTER} --certificate-authority=./ca.crt --server=https://${KUBE_CLUSTER}
            kubectl config set-credentials circleci --token=${KUBE_TOKEN}
            kubectl config set-context ${KUBE_CLUSTER} --cluster=${KUBE_CLUSTER} --user=circleci --namespace=${KUBE_NAMESPACE}
            kubectl config use-context ${KUBE_CLUSTER}
            kubectl get pods
      - run:
          name: Deploy helm chart
          command: |
            RELEASE_NAME=$(cat release_name.txt) 
            helm install "${RELEASE_NAME}" ./charts/cwa-tests \
            -f charts/cwa-tests/Values.yaml \
            --set setup=true \
            --set global.registryAddress="${AWS_ECR_REGISTRY_ID}.dkr.ecr.${ECR_REGION}.amazonaws.com" \
            --wait --timeout 300s

  deploy_tests_on_cloud_platform:
    executor: deploy-executor
    parameters:
      environment:
        description: Destination environment
        type: string
        default: laa-cwa-feature-tests-dev
      token:
        description: CircleCI Service account token
        type: string
        default: ${CIRCLE_CI_TOKEN}
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Load environment variables
          command: |
            if [ -f bash.env ]; then
              cat bash.env >> $BASH_ENV
              source $BASH_ENV
            fi
      - checkout
      - run:
          name: Authenticate with cluster
          command: |
            echo -n ${KUBE_CERT} | base64 -d > ./ca.crt
            kubectl config set-cluster ${KUBE_CLUSTER} --certificate-authority=./ca.crt --server=https://${KUBE_CLUSTER}
            kubectl config set-credentials circleci --token=${KUBE_TOKEN}
            kubectl config set-context ${KUBE_CLUSTER} --cluster=${KUBE_CLUSTER} --user=circleci --namespace=${KUBE_NAMESPACE}
            kubectl config use-context ${KUBE_CLUSTER}
            kubectl get pods
      - run:
          name: Deploy helm chart
          command: |
            export SANITISED_BRANCH=$(echo "${CIRCLE_BRANCH,,}" | sed -r 's/[/_]+/-/g')
            export SHORT_SHA1=$(echo "${CIRCLE_SHA1,,}" | cut -c1-7)
            export SANITISED_BRANCH_WITH_SHA="${SANITISED_BRANCH}-${SHORT_SHA1}"
            helm install "${RELEASE_NAME}" ./charts/cwa-tests \
            -f charts/cwa-tests/Values.yaml \
            --set run=true \
            --set ecr.image.tag="${SANITISED_BRANCH_WITH_SHA}" \
            --set redisSetup.image.tag="${REDIS_SETUP_IMAGE_TAG}" \
            --set global.registryAddress="${AWS_ECR_REGISTRY_ID}.dkr.ecr.${ECR_REGION}.amazonaws.com" \
            --set global.circle_sha1=${CIRCLE_SHA1} \
            --wait --timeout 300s \
            --debug
            export RELEASE_NAME=$(helm list -q | tail -1)
            kubectl logs -f ${RELEASE_NAME} &
      - run:
          name: Creating Artifacts folder
          command: |
            mkdir /tmp/artifacts;
            echo "Test reports for CWA UI tests" > /tmp/artifacts/art-2;
      - run:
          name: Copy output file from pod
          command: |
            export RELEASE_NAME=$(helm list -q | tail -1)
            echo "Captured RELEASE_NAME=${RELEASE_NAME}"
            kubectl cp ${RELEASE_NAME}-redis-setup:/artifacts/feature_file_count.txt /tmp/feature_file_count.txt
      - store_artifacts:
          path: /tmp/feature_file_count.txt
          destination: feature_file_count.txt
      - run:
          name: Wait for specific pod to complete
          command: |
            export POD_NAME=$(kubectl get pods -l meta.helm.sh/release-name=${RELEASE_NAME} -o jsonpath='{.items[?(@.metadata.name=="'${RELEASE_NAME}'-laa-pcuam-cwa-tests")].metadata.name}')
            kubectl wait --for=condition=complete pod/${POD_NAME} --timeout=18000s
      - store_artifacts:
          path: reports
          destination: test-reports
      - run:
          name: Clean namespace
          command:  helm ls -n << parameters.environment >> --short | xargs -L1 -I {} helm uninstall {} -n << parameters.environment >>
      - slack/notify:
          channel: laa-cwa-testing
          event: pass
          mentions: '@pcuam-devs'
          template: basic_success_1

  build_and_push_docker_image:
    executor: build-executor
    steps:
      - checkout
      - run:
          name: Install git-crypt
          command: |
            sudo apt-get update
            sudo apt-get install git-crypt
      - run:
          name: Decrypt secrets
          command: |
            echo "${GIT_CRYPT_KEY}" | base64 -d > git-crypt.key
            git-crypt unlock git-crypt.key
      - aws-cli/setup:
          role_arn: $ECR_ROLE_TO_ASSUME
          region: $ECR_REGION
      - setup_remote_docker:
          docker_layer_caching: true
      - run: |
          aws ecr get-login-password --region $ECR_REGION | docker login --username AWS --password-stdin ${AWS_ECR_REGISTRY_ID}.dkr.ecr.${ECR_REGION}.amazonaws.com
      - run:
          name: Set sanitised branch name
          command: |
            echo 'export SANITISED_BRANCH=$(echo "${CIRCLE_BRANCH,,}-$(echo ${CIRCLE_SHA1} | cut -c1-7)" | sed -r 's/[/_]+/-/g')' >> "$BASH_ENV"
            source "$BASH_ENV"
      - aws-ecr/build-and-push-image:
          push-image: true
          tag: ${SANITISED_BRANCH}
          region: ${ECR_REGION}
          repo: ${ECR_REPOSITORY}
      - slack/notify:
          channel: laa-cwa-testing
          event: fail
          mentions: '@pcuam-devs'
          template: basic_fail_1

  notify_slack_for_approval:
    executor: deploy-executor
    steps:
      - slack/notify:
          channel: laa-cwa-testing
          event: always
          mentions: '@pcuam-devs'
          template: basic_on_hold_1
  
  notify_slack_for_success:
    executor: deploy-executor
    steps:
      - slack/notify:
          channel: laa-cwa-testing
          event: always
          mentions: '@pcuam-devs'
          template: basic_success_1

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - generate_release_name
      - hold_select_environment:
          type: approval
          requires:
            - generate_release_name
      - deploy_test_setup:
          requires:
            - hold_select_environment
      - push_to_redis:
          requires:
            - deploy_test_setup
      - hold_test_setup:
          type: approval
          requires:
            - push_to_redis
      - build_and_push_docker_image:
          requires:
            - hold_test_setup
      - notify_slack_for_approval:
          requires:
            - build_and_push_docker_image
      - hold_test_deployment:
          type: approval
          requires:
            - notify_slack_for_approval
      - deploy_tests_on_cloud_platform:
          requires:
            - hold_test_deployment

  scheduled_ui_test_run:
    jobs:
      - deploy_tests_on_cloud_platform
      - notify_slack_for_success:
          requires:
            - deploy_tests_on_cloud_platform
    triggers:
      - schedule:
          cron: "30 1 * * *"
          filters:
           branches:
            only:
            - main